# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/sre

name: Validate Kubernetes configuration

on:
  pull_request:
    branches:
      - main

concurrency:
  group: k8s-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3.5.3
        with:
          fetch-depth: 0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lint Helm
        run: |
          if [[ ! "$(find ~ -type d -name "product-*" | wc -l)"  -gt "0" ]]; then 
            # Exists successfully since there's no config folder starting with product-*
            echo "No GitOps config directories found, will skip linting."
            exit 0
          fi

          for filename in k8s/product-**/**.yaml; do
            echo "Linting $filename..."

            CHART=$(yq '.spec.chart.spec.chart' "$filename")
            VERSION=$(yq '.spec.chart.spec.version' "$filename")
            yq '.spec.values' -i "$filename"
            helm pull oci://ghcr.io/pleo-io/charts/"$CHART" --version "$VERSION" --untar --untardir .k8s-temp
            helm lint .k8s-temp/"$CHART" --strict --values "$filename"
            rm -rf .k8s-temp/"$CHART"
          done
