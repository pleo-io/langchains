# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/sre

name: Trigger flux application registration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "The environment to register your application to."
        required: true
        default: "product-dev"
        type: choice
        options:
          - product-production
          - product-staging
          - product-dev

jobs:
  trigger-registration:
    name: Trigger ${{ github.event.repository.name }} registration in flux-config
    env:
      FLUX_REGISTRATION_EVENT: "flux-register-application"
    runs-on: ubuntu-latest
    steps:
      - name: Get admin Github token
        id: get-admin-token
        uses: peter-murray/workflow-application-token-action@v2
        with:
          application_id: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_APP_ID }}
          application_private_key: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_PRIVATE_KEY }}

      - name: Invoke workflow - Repository Dispatch
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ steps.get-admin-token.outputs.token }}
          repository: pleo-io/flux-config
          event-type: ${{ env.FLUX_REGISTRATION_EVENT }}
          client-payload: '{"cluster_name": "${{ inputs.environment }}", "application": "${{ github.event.repository.name }}", "default_branch": "${{ github.event.repository.default_branch }}"}'
