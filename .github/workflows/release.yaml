name: Release
on:
  push:
    branches:
      - main

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  create-github-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
    steps:
      - name: Allow pushing version updates to the default branch
        id: get-admin-token
        uses: peter-murray/workflow-application-token-action@v1
        with:
          application_id: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_APP_ID }}
          application_private_key: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ steps.get-admin-token.outputs.token }}
          fetch-depth: 0

      - name: Cache Auto
        id: cache-auto
        uses: actions/cache@v3
        with:
          path: ~/auto
          key: dependency--intuit/auto-v10.37.2

      - name: Setup Auto
        if: steps.cache-auto.outputs.cache-hit != 'true'
        run: |
          curl -vkL -o - https://github.com/intuit/auto/releases/download/v10.37.2/auto-linux.gz | gunzip > ~/auto
          chmod a+x ~/auto

      - name: Run Auto release
        run: |
          ~/auto shipit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-python-package:
    name: Release Python package
    needs: create-github-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
    steps:
      - name: Allow pushing version updates to the default branch
        id: get-admin-token
        uses: peter-murray/workflow-application-token-action@v2
        with:
          application_id: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_APP_ID }}
          application_private_key: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: main
          token: ${{ steps.get-admin-token.outputs.token }}

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Set up Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Cache Auto
        id: cache-auto
        uses: actions/cache@v3
        with:
          path: ~/auto
          key: dependency--intuit/auto-v10.37.2

      - name: Setup Auto
        if: steps.cache-auto.outputs.cache-hit != 'true'
        run: |
          curl -vkL -o - https://github.com/intuit/auto/releases/download/v10.37.2/auto-linux.gz | gunzip > ~/auto
          chmod a+x ~/auto

      - name: Get PR labels
        id: release-label
        run: |
          LABELS="$(~/auto label)"
          echo $LABELS
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version
        if: steps.release-label.outputs.label != 'internal'
        run: |
          poetry version ${{ steps.release-label.outputs.labels }}

      - name: Bump version
        if: steps.release-label.outputs.label != 'internal'
        id: bump-version
        run: |
          echo "version=$(poetry version)" >> $GITHUB_OUTPUT

      - name: Push changes (Git)
        if: steps.release-label.outputs.labels != 'internal'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Release v${{ steps.bump-version.outputs.version }}"
