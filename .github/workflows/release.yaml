name: Release
on:
  push:
    branches:
      - main

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  determine-release:
    name: Determine release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      version: steps.release-label.outputs.version
    steps:
      - name: Cache Auto
        id: cache-auto
        uses: actions/cache@v3
        with:
          path: ~/auto
          key: dependency--intuit/auto-v10.37.2

      - name: Setup Auto
        if: steps.cache-auto.outputs.cache-hit != 'true'
        run: |
          curl -vkL -o - https://github.com/intuit/auto/releases/download/v10.37.2/auto-linux.gz | gunzip > ~/auto
          chmod a+x ~/auto

      - name: Get PR labels
        id: release-label
        run: |
          version="$(~/auto label)"
          echo $version
          echo "version=$version" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-github-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: determine-release
    if: needs.determine-release.outputs.version
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Allow pushing version updates to the default branch
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.RELEASE_KEY }}

      - name: Cache Auto
        id: cache-auto
        uses: actions/cache@v3
        with:
          path: ~/auto
          key: dependency--intuit/auto-v10.37.2

      - name: Setup Auto
        if: steps.cache-auto.outputs.cache-hit != 'true'
        run: |
          curl -vkL -o - https://github.com/intuit/auto/releases/download/v10.37.2/auto-linux.gz | gunzip > ~/auto
          chmod a+x ~/auto

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Set up Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Bump version
        run: |
          poetry version ${{ needs.determine-release.outputs.version }}

      - name: Bump version
        id: bump-version
        run: |
          echo "version=$(poetry version --short)" >> $GITHUB_OUTPUT

      - name: Commit version bump
        uses: EndBug/add-and-commit@v9
        with:
          message: Release v${{ steps.bump-version.outputs.version }}

      - name: Run Auto release
        run: |
          ~/auto shipit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
